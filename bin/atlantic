#!/bin/bash

$(atlantic-env)
# OK, this exports some key stuff.

WORKDIR=$(mktemp -d)
cd $WORKDIR
echo "I: Working in $WORKDIR"
echo "I:"
echo "I: Requesting the next build from the remote."

atlantic-ssh $MONOMOY_BINARY builder-take $MONOMOY_BUILDER_NAME > job
atlantic-job-sanity job
SANE=$?

if [ $SANE -ne 0 ]; then
    echo "E: Insane job spec. Quitting."
    echo "E: Full dump follows"
    echo "E:"
    echo "E: Sanity code: $SANE"
    echo "E:"
    echo "I: File info:"
    ls -l job
    echo "I: Contents:"
    cat job
    if [ "x$ATLANTIC_PURGE" == "x" ]; then
        rm -rf $WORKDIR
    fi
    exit 1
else
    echo "I: OK. Moving on with the build. - Sane: #$SANE"
fi

$(atlantic-env job)
# Re-export with the goodies.
CHROOT_ID="${ATLANTIC_SUITE}-${ATLANTIC_ARCH}-${ATLANTIC_COMPILER}"
dget -x $MONOMOY_DGET/$ATLANTIC_BUILD_DSC

echo "I:"
echo "I: Suite:    $ATLANTIC_SUITE"
echo "I: Arch:     $ATLANTIC_ARCH"
echo "I: Compiler: $ATLANTIC_COMPILER"
echo "I:"

sbuild -d $ATLANTIC_SUITE -c $CHROOT_ID -A *dsc
SANE=$?

BUILD_LOG=$(readlink `find . -type l`)
atlantic-parse-buildlog $BUILD_LOG > ${CHROOT_ID}.report

mv $BUILD_LOG ${CHROOT_ID}.build.txt
echo "$CHROOT_ID $SANE" > ${CHROOT_ID}.exit.txt

ROOT=$(atlantic-ssh $MONOMOY_BINARY get-key $MONOMOY_CONF results)
ROOT=$(echo $ROOT | tr -d "\"")

PTH=${ROOT}/${ATLANTIC_BUILD_POOL}

atlantic-ssh mkdir -p $PTH

for fd in ${CHROOT_ID}.build.txt ${CHROOT_ID}.exit.txt ${CHROOT_ID}.report; do
    scp -i $ATLANTIC_KEY $fd $ATLANTIC_LOGIN@$ATLANTIC_MASTER:$PTH
done

atlantic-ssh $MONOMOY_BINARY builder-done $ATLANTIC_BUILD_ID
atlantic-ssh $MONOMOY_BINARY process-report $PTH/${CHROOT_ID}.report

cd - > /dev/null
if [ "x$ATLANTIC_PURGE" == "x" ]; then
    rm -rf $WORKDIR
fi

exit $SANE
